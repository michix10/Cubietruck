---

- name: Variables de entorno
  set_fact:
    wlan0_address: "{{ lookup('env', 'WLAN0_ADDRESS') }}"
    noip_domain:   "{{ lookup('env', 'NOIP_DOMAIN')   }}"
    noip_username: "{{ lookup('env', 'NOIP_USERNAME') }}"
    noip_password: "{{ lookup('env', 'NOIP_PASSWORD') }}"

- name: Actualizacion de cache de apt
  apt:
    update_cache: yes

- name: Instalacion de paquetes requeridos
  apt:
    name: "{{ item }}"
    state: installed
  with_items:
    - virtualenv
    - python-dev
    - python-pip
    - vim
    - git
    - netfilter-persistent
    - iptables-persistent
    - resolvconf
    - dnsmasq
    - dnsutils
    - ddclient
    - lvm2
    
- name: Configuracion de sysctl
  template:
    src: templates/60-routing.conf
    dest: /etc/sysctl.d/60-routing.conf
    owner: root
    group: root
    mode: "0644"

- name: Copia del script /etc/rc.local
  file:
    src: files/rc.local
    dest: /etc/rc.local
    owner: root
    group: root
    mode: "0644"

- name: Configuracion de NAT
  copy:
    src: files/rules.v4
    dest: /etc/iptables/rules.v4
    owner: root
    group: root
    mode: "0644"
  notify: Reiniciar iptables

- name: Configuracion del servicio netfilter
  service:
    name: netfilter-persistent
    enabled: yes
    state: started

- name: Configuracion de resolvconf
  copy:
    src: files/resolv.conf
    dest: /etc/resolvconf/resolv.conf.d/tail
    owner: root
    group: root
    mode: "0644"
  notify: Reiniciar resolvconf
    
- name: Configuracion de dnsmasq
  copy:
    src: files/eth0.conf
    dest: /etc/dnsmasq.d/eth0.conf
    owner: root
    group: root
    mode: "0644"
  notify: Reiniciar dnsmasq

- name: Incluir el nombre publico en /etc/hosts, para dnsmasq
  when: wlan0_address and noip_domain
  lineinfile:
    dest: /etc/hosts
    regexp: "^{{ wlan0_address }}"
    line: "{{ wlan0_address }} {{ noip_domain }}"
  notify: Reiniciar dnsmasq

- name: Configuracion de noip
  when: noip_domain and noip_username and noip_password
  template:
    src: templates/ddclient.conf
    dest: /etc/ddclient.conf
    owner: root
    group: root
    mode: "0640"
  notify: Reiniciar ddclient

- name: Garantizar que los servicios se inician al arranque
  service:
    name: "{{ item }}"
    enabled: yes
  with_items:
    - netfilter-persistent
    - resolvconf
    - dnsmasq
    - ddclient

- name: Crear grupo generico de servicio
  group:
    name: services
    state: present

- name: Crear usuario cubie
  user:
    name: cubie
    home: /home/cubie
    createhome: yes
    groups: sudo,services
    shell: /bin/bash
    state: present

- name: Crear directorio ssh
  file:
    dest: /home/cubie/.ssh
    state: directory
    owner: cubie
    group: cubie
    mode: "0750"

- name: Cargar la clave publica del usuario remoto
  set_fact:
    ssh_pubkey: "{{ lookup('file', '~/.ssh/id_rsa.pub') }}"

- name: Permitir login a cubie con certificado
  lineinfile:
    dest: /home/cubie/.ssh/authorized_keys
    line: "{{ ssh_pubkey }}"
    create: yes
    owner: cubie
    group: cubie
    mode: 0640

