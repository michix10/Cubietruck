---

- name: Variables de entorno
  set_fact:
    wlan0_ssid:    "{{ lookup('env', 'WLAN0_SSID')    }}"
    wlan0_psk:     "{{ lookup('env', 'WLAN0_PSK')     }}"
    noip_domain:   "{{ lookup('env', 'NOIP_DOMAIN')   }}"
    noip_username: "{{ lookup('env', 'NOIP_USERNAME') }}"
    noip_password: "{{ lookup('env', 'NOIP_PASSWORD') }}"

- name: Instalacion de paquetes requeridos
  sudo: yes
  apt:
    name: "{{ item }}"
    state: installed
  with_items:
    - virtualenv
    - python-dev
    - python-pip
    - vim
    - git
    - netfilter-persistent
    - iptables-persistent
    - resolvconf
    - dnsmasq
    - dnsutils
    - ddclient
    - lvm2
    
- name: Configuracion de red
  sudo: yes
  template:
    src: templates/interfaces
    dest: /etc/network/interfaces
    owner: root
    group: root
    mode: "0644"

- name: Cifrado del password WiFi
  when: wlan0_ssid and wlan0_psk
  shell: wpa_passphrase "{{ wlan0_ssid }}" "{{ wlan0_psk }}" | grep '[^#]psk'
  register: wpa_stdout

- name: Registro del password WiFi cifrado en variable de entorno
  when: wlan0_ssid and wlan0_psk
  set_fact:
    wpa_passphrase: "{{ wpa_stdout.stdout }}"

- name: Configuracion del suplicante wifi
  sudo: yes
  when: wlan0_ssid and wlan0_psk
  template:
    src: templates/wpa_supplicant.conf
    dest: /etc/wpa_supplicant/wpa_supplicant.conf
    owner: root
    group: root
    mode: "0640"

- name: Configuracion de sysctl
  sudo: yes
  template:
    src: templates/60-routing.conf
    dest: /etc/sysctl.d/60-routing.conf
    owner: root
    group: root
    mode: "0644"

- name: Copia del script /etc/rc.local
  sudo: yes
  file:
    src: files/rc.local
    dest: /etc/rc.local
    owner: root
    group: root
    mode: "0644"

- name: Configuracion de NAT
  sudo: yes
  copy:
    src: files/rules.v4
    dest: /etc/iptables/rules.v4
    owner: root
    group: root
    mode: "0644"
  notify: Reiniciar iptables

- name: Configuracion del servicio netfilter
  sudo: yes
  service:
    name: netfilter-persistent
    enabled: yes
    state: started

- name: Configuracion de resolvconf
  sudo: yes
  copy:
    src: files/resolv.conf
    dest: /etc/resolvconf/resolv.conf.d/tail
    owner: root
    group: root
    mode: "0644"
  notify: Reiniciar resolvconf
    
- name: Configuracion de dnsmasq
  sudo: yes
  copy:
    src: files/eth0.conf
    dest: /etc/dnsmasq.d/eth0.conf
    owner: root
    group: root
    mode: "0644"
  notify: Reiniciar dnsmasq

- name: Incluir el nombre publico en /etc/hosts, para dnsmasq
  sudo: yes
  when: wlan0_address and noip_domain
  lineinfile:
    dest: /etc/hosts
    regexp: "^{{ wlan0_address }}"
    line: "{{ wlan0_address }} {{ noip_domain }}"
  notify: Reiniciar dnsmasq

- name: Configuracion de noip
  sudo: yes
  when: noip_domain and noip_username and noip_password
  template:
    src: templates/ddclient.conf
    dest: /etc/ddclient.conf
    owner: root
    group: root
    mode: "0640"
  notify: Reiniciar ddclient

- name: Garantizar que los servicios se inician al arranque
  sudo: yes
  service:
    name: "{{ item }}"
    enabled: yes
  with_items:
    - netfilter-persistent
    - resolvconf
    - dnsmasq
    - ddclient

- name: Crear grupo generico de servicio
  sudo: yes
  group:
    name: services
    state: present
